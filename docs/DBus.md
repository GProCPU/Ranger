# Data Bus (DBus)

The data bus connects the CPU's LSU to program and data memory as well as system peripherals.
It is purely combinatorial logic.


## Ports

### Parameters

- **`XLEN=32`** data width (from rv32)
- **`ROM_ADDR_WIDTH = 10`** ROM address width (word-addressable, default 4kB)
- **`RAM_ADDR_WIDTH = 10`** RAM address width (word-addressable, default 4kB)
- **`AXI_ADDR_WIDTH = 29`** AXI bus address space width (byte-addressable)
- **`ROM_BASE_ADDR = 0x0000_0000`** ROM base address (must be aligned to ROM size)
- **`RAM_BASE_ADDR = 0x4000_0000`** RAM base address (must be aligned to RAM size)
- **`MTIME_BASE_ADDR = 0xC000_0000`** machine timer base address (see [CSR](./CSR.md))
- **`AXI_BASE_ADDR = 0xE000_0000`** AXI bus address space base (must be aligned to AXI address space)
- **`USE_MTIME = 1`** enable generation of machine timer address space
- **`USE_AXI = 1`** enable generation of AXI address space

*localparam*
- **`MTIME_ADDR_WIDTH = 4`** machine timer address width (word-addressable)

### Inputs

- **`rd_en`** read enable flag from LSU
- **`wr_en`** write enable flag from LSU
- **`addr[XLEN-1:0]`** read/write address from LSU
- **`wr_data_i[XLEN-1:0]`** write data from LSU
- **`wr_strobe_i((XLEN/8)-1):0]`** write strobe, indicates which byte lanes hold valid data
- **`rom_rd_data[XLEN-1:0]`** ROM read data
- **`ram_rd_data[XLEN-1:0]`** RAM read data
- **`mtime_rd_data[XLEN-1:0]`** mtime module read data
- **`axi_rd_data[XLEN-1:0]`** AXI interface read data
- **`axi_access_fault`** flag indicating AXI transaction access fault
- **`axi_busy`** flag indicating AXI transaction requires extra cycle

#### Outputs

- **`rd_data[XLEN-1:0]`** read data to LSU
- **`rom_rd_en`** ROM read enable
- **`rom_addr[ROM_ADDR_WIDTH-1:0]`** ROM address (word-addressable)
- **`ram_rd_en`** RAM read enable
- **`ram_wr_en`** RAM write enable
- **`ram_addr[RAM_ADDR_WIDTH-1:0]`** RAM address (word-addressable)
- **`mtime_rd_en`** mtime module read enable
- **`mtime_wr_en`** mtime module write enable
- **`mtime_addr[1:0]`** mtime module address (word-addressable)
- **`axi_rd_en`** AXI interface read enable
- **`axi_wr_en`** AXI interface write enable
- **`axi_addr[AXI_ADDR_WIDTH-1:0]`** AXI interface address (byte-addressable)
- **`wr_data_o[XLEN-1:0]`** shared write data
- **`wr_strobe_o((XLEN/8)-1):0]`** write strobe, indicates which byte lanes hold valid data
- **`data_misaligned`** asserted if memory address is not 4-byte aligned
- **`data_access_fault`** access fault flag to Trap Unit
- **`load_store_n`** indicates if exception was generated by load or store (0=store,1=load)
- **`dbus_wait`** flag indicating dbus transaction requires extra cycle
- **`dbus_err`** logical or of `data_misaligned` and `data_access_fault`


## Behavior

Addresses are decoded according to the [memory map](./Ranger.md#memory-map), then transactions are routed to the appropriate device.
Output addresses are hardwired to the appropriate input address bits.
The read/write enable signals are controlled by a memory map address decoder.

The DBus is also responsible for detecting misaligned data memory accesses as well as data memory access faults.

- `data_misaligned` is high if `rd_en` or `wr_en` are high and the address `alu_result` is not four-byte aligned (i.e. lowest two bits must be zero), else low.
- `data_access_fault` is high if `rd_en` or `wr_en` are high and `addr` is outside all legal address spaces. Additionally, it is high if `rd_en` or `wr_en` is high and `addr` is in the AXI address space.

The `load_store_n` signal indicates to the trap unit if an exception was generated by a load or a store instruction.
It should be high if `rd_en` is asserted, else low.

The `dbus_wait` signal set to `axi_busy` if `rd_en` or `wr_en` is high and `addr` is in the AXI address space.

***Important:** all addresses must be naturally aligned to their address space and address spaces must not overlap. If not, behavior is undefined*

### Memory Mapped Devices

The DBus routes read/write transactions to memory mapped system devices.
This implementation includes the machine timer (mtime).
The address map is located in Table 1.

**Table 1.** Memory Mapped System Devices

| Address | Device | Description |
| --- | --- | --- |
| 0xC000_000 - 0xC00_000F | `mtime` | system timer

Memory mapped peripheral devices are connected via the AXI interface.
The peripheral address map can be found in the [AXI4-Lite Crossbar](./AXI4-Lite_Crossbar.md) document.
